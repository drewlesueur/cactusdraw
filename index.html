<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Canvas Draw</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
  <script src="http://cactus.the.tl:8090/socket.io/socket.io.js"></script>
  <script>
    var draw
    var socket = io.connect('http://cactus.the.tl:8090');
    socket.on('line', function (data) {
      draw(data)
    });
  </script>
	<style>
	* {
		border: 0;
		margin: 0;
		padding: 0;
	}
	html, body {
		width: 100%;
		height: 100%;
		overflow: hidden;
	}
	#topbar {
		height: 48px;
		background-color: blue;
	}
	#cactus {

	}
	</style>
</head>
<body>
<div id="topbar">
	<img id="cactus" src="cactus.jpg" width="48px" height="48px" alt="Cactus" /> Cactus Draw
</div>
<canvas id="canvas" width="100" height="100"><p>Your browser doesn't support canvas</p></canvas>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script>
	$(document).ready(function () {
		"use strict";

		var $window = $(window);
		var $topbar = $("#topbar");

		var $canvas = $("#canvas");
		var canvas = $canvas.get(0);

		var ctx = canvas.getContext('2d');

		draw = function (options) {
			if(options.color) {
				ctx.strokeStyle = options.color;
			}
			ctx.beginPath();
			ctx.moveTo(options.x1, options.y1);
			ctx.lineTo(options.x2, options.y2);
			ctx.stroke();
      socket.emit("line", options)
		};

		// Offset the window drawing position by the canvas's position so it'll draw on the canvas
		var canvasLeft = canvas.offsetLeft;
		var canvasTop = canvas.offsetTop;

		// xPos and yPos are previous point, drawing is 'mouse or touch is down' e.g. currently drawing
		var drawing = false, userColor = "#000000", xPos, yPos;

		var handleMove = function (x, y) {
			// Offset the window drawing position by the canvas's position so it'll draw on the canvas
			var x = x - canvasLeft,
				y = y - canvasTop;
			if (x === xPos && y === yPos) {
				return; // We're already there
			}

			if (!drawing) {
				drawing = true;
			} else {
				draw({color: userColor, x1: xPos, y1: yPos, x2: x, y2: y});
			}
			xPos = x;
			yPos = y;
		};

		if (Modernizr.touch) {
			// touch
			$canvas.bind('touchstart', function (e) {
				$canvas.bind('touchmove', function (event) {
					event.preventDefault();
					handleMove(event.targetTouches[0].pageX, event.targetTouches[0].pageY);
					return false;
				});
			});
			$(document).bind('touchend', function (event) {
				$canvas.unbind('touchmove');
				drawing = false;
			});
		} else {
			// mouse
			$canvas.mousedown(function (e) {
				if (e.button === 0) {
					$canvas.bind('mousemove', function (event) {
						event.preventDefault();
						handleMove(event.clientX, event.clientY);
						return false;
					});
				}
			});
			$(document).mouseup(function (event) {
				$canvas.unbind('mousemove');
				drawing = false;
			});
		}

		// If the window resizes, resize the canvas
		// FRAGILE: blanks the canvas in the process
		var resizeCanvas = function () {
			// Can't set $("#canvas").width() because jQuery is going to scale, not resize
			// TODO: capture data and write to avoid blanking on resize
			//var data = ctx.getImageData();
			canvas.width = $window.width();
			canvas.height = $window.height() - $topbar.height();
			//ctx.putImageData(data);
		};
		//$window.resize(resizeCanvas);
		resizeCanvas();

	});
</script>
</body>
</html>
